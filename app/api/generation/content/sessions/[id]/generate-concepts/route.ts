import { NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import OpenAI from 'openai'

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
})

type RouteParams = {
  params: Promise<{
    id: string
  }>
}

export async function POST(
  request: Request,
  { params }: RouteParams
) {
  try {
    const { id } = await params
    
    // Validate ID
    if (!id || id === 'undefined' || id === 'null') {
      return NextResponse.json(
        { error: 'Invalid session ID' },
        { status: 400 }
      )
    }
    
    // „Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂèñÂæó
    const session = await prisma.viralSession.findUnique({
      where: { id }
    })
    
    if (!session) {
      return NextResponse.json(
        { error: 'Session not found' },
        { status: 404 }
      )
    }
    
    if (!session.topics || session.status !== 'TOPICS_COLLECTED') {
      return NextResponse.json(
        { error: 'Topics not collected yet' },
        { status: 400 }
      )
    }

    // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
    await prisma.viralSession.update({
      where: { id },
      data: { status: 'GENERATING_CONCEPTS' }
    })

    const topics = (session.topics as any).parsed || []
    
    if (topics.length === 0) {
      throw new Error('No topics found in session')
    }

    // ÊúÄ„ÇÇÊúâÊúõ„Å™2„Å§„ÅÆ„Éà„Éî„ÉÉ„ÇØ„ÅÆ„Åø„ÇíÂá¶ÁêÜ
    const topicsToProcess = topics.slice(0, 2)
    console.log(`Processing ${topicsToProcess.length} most promising topics`)
    
    // ÂêÑ„Éà„Éî„ÉÉ„ÇØ„Å´ÂØæ„Åó„Å¶3„Å§„ÅÆ„Ç≥„É≥„Çª„Éó„Éà„ÇíÁîüÊàê
    const conceptPromises = topicsToProcess.map(async (topic: any, topicIndex: number) => {
      const prompt = `„ÅÇ„Å™„Åü„ÅØ„ÄÅÊñ∞„Åü„Å™„Éà„É¨„É≥„Éâ„ÇíÁâπÂÆö„Åó„ÄÅÊµÅË°å„ÅÆÊ≥¢„Åå„Éî„Éº„ÇØ„Å´ÈÅî„Åô„ÇãÂâç„Å´„Åù„ÅÆÊ≥¢„Å´‰πó„Çã„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ„Ç≥„É≥„Çª„Éó„Éà„Çí‰ΩúÊàê„Åô„Çã„Éê„Ç∫„Çã„Ç≥„É≥„ÉÜ„É≥„ÉÑÊà¶Áï•ÂÆ∂„Åß„Åô„ÄÇ

‰ª•‰∏ã„ÅÆ„Éà„Éî„ÉÉ„ÇØ„Å´„Å§„ÅÑ„Å¶„ÄÅ„Äê${session.platform}„Äë„Åß„Äê${session.style}„Äë„Çπ„Çø„Ç§„É´„Åß„Éê„Ç∫„ÇãÊäïÁ®ø„Ç≥„É≥„Çª„Éó„Éà„Çí3„Å§‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„Éà„Éî„ÉÉ„ÇØ: ${topic.TOPIC}
ÂàÜÊûê: ${topic.perplexityAnalysis}
URL: ${topic.url}

„Äê„Éï„ÉÉ„ÇØ„Äë

‚óè‰ª•‰∏ã„ÅÆ5Á®ÆÈ°û„ÅÆ„ÅÜ„Å°„ÅÑ„Åö„Çå„ÅãÔºà„Åæ„Åü„ÅØÁµÑ„ÅøÂêà„Çè„ÅõÔºâ„Çí‰Ωø„Å£„Å¶„ÄÅÂøÉ„Çí„Å§„Åã„ÇÄ„Äå„Ç™„Éº„Éó„Éã„É≥„Ç∞„Éï„ÉÉ„ÇØ„Äç„Çí3„Å§ËÄÉ„Åà„Å¶„Åè„Å†„Åï„ÅÑÔºö
    1.    ÊÑèÂ§ñÊÄßÔºàSurpriseÔºâÔºöÂ∏∏Ë≠ò„ÅÆÈÄÜ„Çí„Å§„ÅèÔºèÊÉ≥ÂÆöÂ§ñ„ÅÆÂ±ïÈñã
    2.    Á∑äÊÄ•ÊÄßÔºàUrgencyÔºâÔºö‰ªä„Åô„ÅêÁü•„Çã„Åπ„ÅçÔºèÊôÇÈñì„ÇÑÊúüÈôê„ÇíÊÑèË≠ò„Åï„Åõ„Çã
    3.    Ëá™Â∑±ÊäïÂΩ±ÔºàIdentityÔºâÔºöË™≠ËÄÖ„Åå„ÄåËá™ÂàÜ„ÅÆ„Åì„Å®„Å†„Äç„Å®ÊÑü„Åò„ÇãË¶ñÁÇπ
    4.    Êï∞Â≠ó„Éª„É≠„Ç∏„ÉÉ„ÇØÔºàClarityÔºâÔºö„Éá„Éº„Çø„ÇÑÂÖ∑‰ΩìÊÄß„Å´„Çà„ÇãË™¨ÂæóÂäõ
    5.    Âïè„ÅÑ„ÉªÊú™ÂÆåÊÄßÔºàTensionÔºâÔºöÁ≠î„Åà„ÅåÁü•„Çä„Åü„Åè„Å™„ÇãÂïè„ÅÑ„Åã„ÅëÔºèÈÄî‰∏≠„ÅßÊ≠¢„ÇÅ„Çã‰ΩôÁôΩ

‚∏ª

„ÄêËßíÂ∫¶„Äë

‚óè‰∏äË®ò„ÅÆ„Éï„ÉÉ„ÇØ„ÇíÊ¥ª„Åã„Åó„ÄÅ‰ª•‰∏ã„ÅÆË¶≥ÁÇπ„Çí„ÇÇ„Å®„Å´"Áã¨Ëá™„ÅÆÂàá„ÇäÂè£"„Çí3„Å§ÊßãÊÉ≥„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
    ‚Ä¢    ‰∏ñ„ÅÆÊµÅ„Çå„Å´ÂØæ„Åó„Å¶"ÈÄÜÂºµ„Çä„Åô„Çã"Ë¶ñÁÇπ
    ‚Ä¢    ÂΩì‰∫ãËÄÖ„ÇÑÂ∞ÇÈñÄÂÆ∂„ÅÆ"„É™„Ç¢„É´„Å™Â£∞"„Å´Âü∫„Å•„ÅèÂàÜÊûê
    ‚Ä¢    ÂÄã‰∫∫ÁöÑ„Å™‰ΩìÈ®ì„ÇÑ‰∫∫ÈñìÈñ¢‰øÇ„ÇíËµ∑ÁÇπ„Å®„Åó„Åü"„Çπ„Éà„Éº„É™„ÉºÂûã"
    ‚Ä¢    ËÉåÊôØ„ÇÑÊßãÈÄ†„ÇíËß£„Åç„Åª„Åê„Åô"„Çè„Åã„Çä„ÇÑ„Åô„ÅÑËß£Ë™¨Âûã"
    ‚Ä¢    ‰ªäÂæå„ÅÆÂãï„Åç„ÇÑÊ≥¢ÂèäÂäπÊûú„ÇíË™≠„ÇÄ"‰∫àÊ∏¨„ÉªËÄÉÂØüÂûã"
    ‚Ä¢    Ë¶ã„Åà„Å•„Çâ„ÅÑÈÉ®ÂàÜ„Å´ÁÑ¶ÁÇπ„ÇíÂΩì„Å¶„Çã"ËàûÂè∞Ë£è„ÇÑË£èË©±ÁöÑË¶ñÁÇπ"
    ‚Ä¢    ÈÅéÂéª„ÅÆÂá∫Êù•‰∫ã„Å®„ÅÆ"ÊØîËºÉ„ÇÑÂèÇÁÖß"„Å´„Çà„ÇãÊßãÈÄ†ÁöÑË¶ñÁÇπ
    ‚Ä¢    Ë™§Ëß£„ÇÑÂ∏∏Ë≠ò„ÇíË¶Ü„Åô"Á•ûË©±Á†¥Â£äÂûã"
    ‚Ä¢    ÂÖ∑‰Ωì‰æã„ÇíÊ∑±Â†Ä„Çä„Åô„Çã"„Ç±„Éº„Çπ„Çπ„Çø„Éá„Ç£Âûã"
    ‚Ä¢    Áµ±Ë®à„ÇÑ„Ç∞„É©„Éï„ÅßË™û„Çã"„Éá„Éº„ÇøÈßÜÂãïÂûã"
    ‚Ä¢    Á§æ‰ºöÁöÑË™≤È°å„ÇíÊµÆ„ÅçÂΩ´„Çä„Å´„Åô„Çã"ÂïèÈ°åÊèêËµ∑Âûã"
    ‚Ä¢    ÂÆüÁî®ÁöÑ„Å™„Éí„É≥„Éà„ÇíÊèê‰æõ„Åô„Çã"„É©„Ç§„Éï„Éè„ÉÉ„ÇØÂûã"

‚∏ª

„ÄêÊäïÁ®øÊßãÈÄ†„Äë

‚óè‰∏ãË®ò„ÅÆÊµÅ„Çå„Å´Ê≤ø„Å£„Å¶„ÄÅ1ÊäïÁ®ø„ÇíÊßãÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
    1.    „Ç™„Éº„Éó„Éã„É≥„Ç∞„Éï„ÉÉ„ÇØ
„ÄÄüëâ ËààÂë≥„ÇíÂºï„ÅèÊúÄÂàù„ÅÆ‰∏ÄÊñáÔºàÈ©ö„Åç„ÉªÂïè„ÅÑ„ÉªÈÄÜË™¨ „Å™„Å©Ôºâ
„ÄÄ‰æãÔºö„Äå„Åü„Å£„Åü1„Å§„ÅÆÂ∑•Â§´„Åß„ÄÅ‰ªï‰∫ã„Åå3ÂÄçÈÄü„Åè„Å™„Çã„Å®„Åó„Åü„ÇâÔºü„Äç
    2.    ËÉåÊôØÔºèÂïèÈ°åÊèêËµ∑ÔºàWhyÔºâ
„ÄÄüëâ „Å™„Åú„Åù„ÅÆË©±„Åå‰ªäÈáçË¶Å„Å™„ÅÆ„ÅãÔºè„Å©„Çì„Å™Ë™≤È°å„ÇíÊâ±„ÅÜ„ÅÆ„Åã
„ÄÄ‰æãÔºö„ÄåÂ§ö„Åè„ÅÆ‰∫∫„Åå„ÄÅ"ÊÉÖÂ†±„Å´ÊåØ„ÇäÂõû„Åï„Çå„ÇãÂÉç„ÅçÊñπ"„Çí„Åó„Å¶„ÅÑ„Çã„Äç
    3.    ÂÖ∑‰ΩìÁöÑ„Å™‰∏≠Ë∫´ÔºàWhat/HowÔºâ
„ÄÄüëâ „Éé„Ç¶„Éè„Ç¶„Éª‰ΩìÈ®ìË´á„ÉªÊï∞Â≠ó„Éª„Çπ„Éà„Éº„É™„Éº„Å™„Å©„ÄÇÁÆáÊù°Êõ∏„Åç„Åß„ÇÇÂèØ
„ÄÄ‰æãÔºö„Äå„Åº„Åè„ÅåË©¶„Åó„Åü„ÅÆ„ÅØ„ÄÅ"Êúù10ÂàÜ„Å†„Åë„ÅÆ‚óã‚óãÁøíÊÖ£"„Äç
    4.    „Åæ„Å®„ÇÅ„ÉªÂÜÖÁúÅ„ÉªÂÖ±ÊÑüÔºàSo WhatÔºâ
„ÄÄüëâ Ë™≠ËÄÖ„Å´Âïè„ÅÑ„Åã„Åë„ÇãÔºèÂÖ±ÊÑü„ÇíÂºï„ÅçÂá∫„ÅôÔºè‰æ°ÂÄ§„Å•„Åë„Åô„Çã
„ÄÄ‰æãÔºö„ÄåÂ§ßÂàá„Å™„ÅÆ„ÅØ„ÄÅ„ÉÑ„Éº„É´„Åò„ÇÉ„Å™„Åè"‰Ωø„ÅÑÊñπ"„Å†„Å£„Åü„Äç
    5.    CTAÔºàË°åÂãï„ÅÆ„Åç„Å£„Åã„ÅëÔºâ
„ÄÄüëâ „Ç≥„É°„É≥„Éà„ÉªRT„Éª‰øùÂ≠ò„Éª„Éó„É≠„Éï„Ç£„Éº„É´Ë™òÂ∞é„Å™„Å©
„ÄÄ‰æãÔºö„Äå„ÅÇ„Å™„Åü„ÅÆÁøíÊÖ£Ë°ì„ÄÅ„Çà„Åã„Å£„Åü„ÇâÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„Äç

‚∏ª

„Äê„Éì„Ç∏„É•„Ç¢„É´Ê°à„Äë

‚óèÊäïÁ®ø„ÅÆÂç∞Ë±°„ÇíÈ´ò„ÇÅ„ÇãÁîªÂÉè„ÇÑÂãïÁîª„ÅÆÊñπÂêëÊÄß„ÇíÊèêÊ°à„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰æãÔºö
    ‚Ä¢    „Ç∞„É©„Éï„ÇÑÊï∞Â≠ó„ÇíÂº∑Ë™ø„Åó„Åü„Ç§„É≥„Éï„Ç©„Ç∞„É©„Éï„Ç£„ÉÉ„ÇØ
    ‚Ä¢    before‚Üíafter„ÅßÂ§âÂåñ„Åå‰ºù„Çè„Çã2ÊûöÊØîËºÉÁîªÂÉè
    ‚Ä¢    ÊÑüÊÉÖ„Å´Ë®¥„Åà„ÇãÂÜôÁúüÔºàÈ°î„ÉªÊâã„ÉªÁ©∫„ÉªÁ¥ô„Å™„Å©„ÅÆÊäΩË±°Ôºâ
    ‚Ä¢    ÊâãÊõ∏„ÅçÈ¢®„ÅÆÂõ≥Ëß£
    ‚Ä¢    „É¢„Éé„É≠„Éº„Ç∞Á≥ª„ÅÆÈùô„Åã„Å™ÂãïÁîª

‚∏ª

„ÄêÊäïÁ®ø„Çø„Ç§„Éü„É≥„Ç∞„Äë

‚óè„Çø„Éº„Ç≤„ÉÉ„ÉàÂ±§„Å´Âêà„Çè„Åõ„Å¶„ÄÅÊúÄÈÅ©„Å™ÊäïÁ®øÊôÇÈñìÂ∏Ø„Å®ÊõúÊó•„ÇíÊèêÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰æãÔºö
    ‚Ä¢    Âπ≥Êó•Â§úÔºà21ÊôÇ„Äú23ÊôÇÔºâ
    ‚Ä¢    Êó•ÊõúÂ§ïÊñπÔºà„ÄåÊòéÊó•„Åã„Çâ„Äç„É¢„Éº„Éâ„ÇíÊ¥ªÁî®Ôºâ
    ‚Ä¢    ÊúàÊõúÊúùÔºà„É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥Á≥ª„Å´Âº∑„ÅÑÔºâ

„ÄêËßíÂ∫¶„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„É´„Éº„É´„Äë
- ÂêÑ„Ç≥„É≥„Çª„Éó„Éà„ÅØÁï∞„Å™„ÇãËßíÂ∫¶„Çí‰ΩøÁî®„Åô„Çã„Åì„Å®
- 2-3ÂÄã„ÅÆËßíÂ∫¶„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„ÇãÂ†¥Âêà„ÅØ„ÄÅÁõ∏‰πóÂäπÊûú„ÇíÁãô„ÅÜ„Åì„Å®
- Âêå„ÅòËßíÂ∫¶„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÇíÁπ∞„ÇäËøî„Åï„Å™„ÅÑ„Åì„Å®

„Åæ„Åü„ÄÅÊßãÊÉ≥„Åó„Åü„Ç≥„É≥„Çª„Éó„Éà„Åå‰∏ÄÁõÆ„ÅßÂàÜ„Åã„Çã„Çà„ÅÜ„ÄÅÂêÑ„Ç≥„É≥„Çª„Éó„Éà„Å´20ÊñáÂ≠ó‰ª•ÂÜÖ„ÅÆ„Çø„Ç§„Éà„É´„Çí‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

ÊßãÊÉ≥„Åó„Åü„Ç≥„É≥„Çª„Éó„Éà„Å´„Åµ„Åï„Çè„Åó„ÅÑ„ÅÆ„ÅØÂçòÁã¨ÊäïÁ®ø„Åã„ÉÑ„É™„ÉºÊäïÁ®ø„Åã„ÇÇÊåáÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
- single: ÂçòÁã¨ÊäïÁ®øÔºà140ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÂÆåÁµêÔºâ
- thread: „ÉÑ„É™„ÉºÊäïÁ®øÔºàË§áÊï∞„ÅÆÊäïÁ®ø„ÅßË©≥Á¥∞„Å´Â±ïÈñãÔºâ

ÂøÖ„Åö‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„Åß3„Å§„ÅÆ„Ç≥„É≥„Çª„Éó„Éà„ÇíÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
[
  {
    "conceptId": "topic${topicIndex + 1}_concept1",
    "conceptTitle": "„Ç≥„É≥„Çª„Éó„Éà„ÅÆ„Çø„Ç§„Éà„É´Ôºà20ÊñáÂ≠ó‰ª•ÂÜÖÔºâ",
    "format": "single/thread„ÅÆ„ÅÑ„Åö„Çå„Åã",
    "hookType": "‰ΩøÁî®„Åó„Åü„Éï„ÉÉ„ÇØ„ÅÆÁ®ÆÈ°û",
    "hookCombination": ["ÁµÑ„ÅøÂêà„Çè„Åõ„ÅüÂ†¥Âêà„ÅÆ„Éï„ÉÉ„ÇØ„Çø„Ç§„Éó"],
    "angle": "„É°„Ç§„É≥ËßíÂ∫¶",
    "angleCombination": ["‰ΩøÁî®„Åó„ÅüËßíÂ∫¶„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ"],
    "angleRationale": "„Å™„Åú„Åì„ÅÆËßíÂ∫¶/ÁµÑ„ÅøÂêà„Çè„Åõ„ÅåÂäπÊûúÁöÑ„Åã„ÄÅ„Å™„Åú„Åì„ÅÆÂΩ¢Âºè„ÇíÈÅ∏„Çì„Å†„Åã",
    "viralScore": 85,
    "viralFactors": ["„Éê„Ç∫„ÇãË¶ÅÂõ†1", "„Éê„Ç∫„ÇãË¶ÅÂõ†2"],
    "structure": {
      "openingHook": "„Å©„ÅÆ„Çà„ÅÜ„Å™È©ö„Åç„ÇÑÂïè„ÅÑ„Åã„Åë„ÅßÂßã„ÇÅ„Çã„Åã",
      "background": "„Å©„Çì„Å™ÁèæÁä∂Ë™çË≠ò„ÇÑÂïèÈ°åÊÑèË≠ò„ÇíÊèêÁ§∫„Åô„Çã„Åã",
      "mainContent": "„Å©„Çì„Å™‰∫ãÂÆü„Éª‰ΩìÈ®ì„ÉªÂàÜÊûê„ÇíÂ±ïÈñã„Åô„Çã„Åã",
      "reflection": "„Å©„ÅÆ„Çà„ÅÜ„Å™ÂÖ±ÊÑü„Éù„Ç§„É≥„Éà„ÇÑ‰æ°ÂÄ§„Å•„Åë„Çí„Åô„Çã„Åã",
      "cta": "„Å©„Çì„Å™Ë°åÂãï„Çí‰øÉ„Åô„ÅãÔºà„Ç≥„É°„É≥„Éà„ÉªRT„Éª‰øùÂ≠ò„Å™„Å©Ôºâ"
    },
    "visual": "„Éì„Ç∏„É•„Ç¢„É´Ê°à",
    "timing": "ÊäïÁ®ø„Çø„Ç§„Éü„É≥„Ç∞",
    "hashtags": ["Èñ¢ÈÄ£„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞"]
  },
  {
    "conceptId": "topic${topicIndex + 1}_concept2",
    "conceptTitle": "„Ç≥„É≥„Çª„Éó„Éà„ÅÆ„Çø„Ç§„Éà„É´Ôºà20ÊñáÂ≠ó‰ª•ÂÜÖÔºâ",
    "format": "single/thread„ÅÆ„ÅÑ„Åö„Çå„Åã",
    "hookType": "‰ΩøÁî®„Åó„Åü„Éï„ÉÉ„ÇØ„ÅÆÁ®ÆÈ°û",
    "hookCombination": ["ÁµÑ„ÅøÂêà„Çè„Åõ„ÅüÂ†¥Âêà„ÅÆ„Éï„ÉÉ„ÇØ„Çø„Ç§„Éó"],
    "angle": "„É°„Ç§„É≥ËßíÂ∫¶",
    "angleCombination": ["‰ΩøÁî®„Åó„ÅüËßíÂ∫¶„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ"],
    "angleRationale": "„Å™„Åú„Åì„ÅÆËßíÂ∫¶/ÁµÑ„ÅøÂêà„Çè„Åõ„ÅåÂäπÊûúÁöÑ„Åã„ÄÅ„Å™„Åú„Åì„ÅÆÂΩ¢Âºè„ÇíÈÅ∏„Çì„Å†„Åã",
    "viralScore": 82,
    "viralFactors": ["„Éê„Ç∫„ÇãË¶ÅÂõ†1", "„Éê„Ç∫„ÇãË¶ÅÂõ†2"],
    "structure": {
      "openingHook": "„Å©„ÅÆ„Çà„ÅÜ„Å™È©ö„Åç„ÇÑÂïè„ÅÑ„Åã„Åë„ÅßÂßã„ÇÅ„Çã„Åã",
      "background": "„Å©„Çì„Å™ÁèæÁä∂Ë™çË≠ò„ÇÑÂïèÈ°åÊÑèË≠ò„ÇíÊèêÁ§∫„Åô„Çã„Åã",
      "mainContent": "„Å©„Çì„Å™‰∫ãÂÆü„Éª‰ΩìÈ®ì„ÉªÂàÜÊûê„ÇíÂ±ïÈñã„Åô„Çã„Åã",
      "reflection": "„Å©„ÅÆ„Çà„ÅÜ„Å™ÂÖ±ÊÑü„Éù„Ç§„É≥„Éà„ÇÑ‰æ°ÂÄ§„Å•„Åë„Çí„Åô„Çã„Åã",
      "cta": "„Å©„Çì„Å™Ë°åÂãï„Çí‰øÉ„Åô„ÅãÔºà„Ç≥„É°„É≥„Éà„ÉªRT„Éª‰øùÂ≠ò„Å™„Å©Ôºâ"
    },
    "visual": "„Éì„Ç∏„É•„Ç¢„É´Ê°à",
    "timing": "ÊäïÁ®ø„Çø„Ç§„Éü„É≥„Ç∞",
    "hashtags": ["Èñ¢ÈÄ£„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞"]
  },
  {
    "conceptId": "topic${topicIndex + 1}_concept3",
    "conceptTitle": "„Ç≥„É≥„Çª„Éó„Éà„ÅÆ„Çø„Ç§„Éà„É´Ôºà20ÊñáÂ≠ó‰ª•ÂÜÖÔºâ",
    "format": "single/thread„ÅÆ„ÅÑ„Åö„Çå„Åã",
    "hookType": "‰ΩøÁî®„Åó„Åü„Éï„ÉÉ„ÇØ„ÅÆÁ®ÆÈ°û",
    "hookCombination": ["ÁµÑ„ÅøÂêà„Çè„Åõ„ÅüÂ†¥Âêà„ÅÆ„Éï„ÉÉ„ÇØ„Çø„Ç§„Éó"],
    "angle": "„É°„Ç§„É≥ËßíÂ∫¶",
    "angleCombination": ["‰ΩøÁî®„Åó„ÅüËßíÂ∫¶„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ"],
    "angleRationale": "„Å™„Åú„Åì„ÅÆËßíÂ∫¶/ÁµÑ„ÅøÂêà„Çè„Åõ„ÅåÂäπÊûúÁöÑ„Åã„ÄÅ„Å™„Åú„Åì„ÅÆÂΩ¢Âºè„ÇíÈÅ∏„Çì„Å†„Åã",
    "viralScore": 88,
    "viralFactors": ["„Éê„Ç∫„ÇãË¶ÅÂõ†1", "„Éê„Ç∫„ÇãË¶ÅÂõ†2"],
    "structure": {
      "openingHook": "„Å©„ÅÆ„Çà„ÅÜ„Å™È©ö„Åç„ÇÑÂïè„ÅÑ„Åã„Åë„ÅßÂßã„ÇÅ„Çã„Åã",
      "background": "„Å©„Çì„Å™ÁèæÁä∂Ë™çË≠ò„ÇÑÂïèÈ°åÊÑèË≠ò„ÇíÊèêÁ§∫„Åô„Çã„Åã",
      "mainContent": "„Å©„Çì„Å™‰∫ãÂÆü„Éª‰ΩìÈ®ì„ÉªÂàÜÊûê„ÇíÂ±ïÈñã„Åô„Çã„Åã",
      "reflection": "„Å©„ÅÆ„Çà„ÅÜ„Å™ÂÖ±ÊÑü„Éù„Ç§„É≥„Éà„ÇÑ‰æ°ÂÄ§„Å•„Åë„Çí„Åô„Çã„Åã",
      "cta": "„Å©„Çì„Å™Ë°åÂãï„Çí‰øÉ„Åô„ÅãÔºà„Ç≥„É°„É≥„Éà„ÉªRT„Éª‰øùÂ≠ò„Å™„Å©Ôºâ"
    },
    "visual": "„Éì„Ç∏„É•„Ç¢„É´Ê°à",
    "timing": "ÊäïÁ®ø„Çø„Ç§„Éü„É≥„Ç∞",
    "hashtags": ["Èñ¢ÈÄ£„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞"]
  }
]`

      const response = await openai.chat.completions.create({
        model: 'gpt-4o',
        messages: [
          {
            role: 'system',
            content: 'JSONÂΩ¢Âºè„ÅßÊ≠£Á¢∫„Å´Âá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.8,
        max_tokens: 3500
      })

      const content = response.choices[0].message.content || '[]'
      let concepts = []
      
      try {
        concepts = JSON.parse(content)
      } catch (e) {
        console.error('Failed to parse concepts:', e)
        // JSON„Éñ„É≠„ÉÉ„ÇØ„ÇíÊé¢„Åô
        const jsonMatch = content.match(/\[[\s\S]*\]/);
        if (jsonMatch) {
          try {
            concepts = JSON.parse(jsonMatch[0])
          } catch (e2) {
            console.error('Failed to parse extracted JSON:', e2)
          }
        }
      }

      // „Éà„Éî„ÉÉ„ÇØÊÉÖÂ†±„ÇíÂêÑ„Ç≥„É≥„Çª„Éó„Éà„Å´ËøΩÂä†
      return concepts.map((concept: any) => ({
        ...concept,
        topicTitle: topic.TOPIC,
        topicUrl: topic.url,
        topicSummary: topic.summary
      }))
    })

    const allConceptsArrays = await Promise.all(conceptPromises)
    const allConcepts = allConceptsArrays.flat()

    console.log(`Generated ${allConcepts.length} concepts total`)

    // „Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞
    const updatedSession = await prisma.viralSession.update({
      where: { id },
      data: {
        concepts: allConcepts,
        status: 'CONCEPTS_GENERATED'
      }
    })

    return NextResponse.json({
      success: true,
      session: updatedSession,
      conceptsCount: allConcepts.length
    })
    
  } catch (error) {
    console.error('Error generating concepts:', error)
    
    // „Ç®„É©„ÉºÊôÇ„ÅØ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊàª„Åô
    try {
      await prisma.viralSession.update({
        where: { id: (await params).id },
        data: { status: 'TOPICS_COLLECTED' }
      })
    } catch (e) {
      // „É™„Çª„ÉÉ„Éà„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñ
    }
    
    return NextResponse.json(
      { error: 'Failed to generate concepts' },
      { status: 500 }
    )
  }
}