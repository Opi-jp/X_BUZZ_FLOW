require('dotenv').config()
const OpenAI = require('openai')

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
})

// Perplexityã‹ã‚‰ã®å®Ÿéš›ã®å‡ºåŠ›ä¾‹ï¼ˆAIã¨åƒãæ–¹ã®ãƒˆãƒ”ãƒƒã‚¯ï¼‰
const mockTopic = {
  TOPIC: "AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå¤‰ãˆã‚‹æœªæ¥ã®åƒãæ–¹ï¼š2025å¹´ã®è·å ´é©å‘½",
  perplexityAnalysis: "AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å°å…¥ã«ã‚ˆã‚Šã€ä¼æ¥­ã®æ¥­å‹™åŠ¹ç‡ãŒåŠ‡çš„ã«å‘ä¸Šã—ã¦ã„ã‚‹ã€‚ç‰¹ã«äº‹å‹™ä½œæ¥­ã®è‡ªå‹•åŒ–ã«ã‚ˆã‚Šã€äººé–“ã¯ã‚ˆã‚Šå‰µé€ çš„ãªä»•äº‹ã«é›†ä¸­ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚ä¸€æ–¹ã§ã€AIã«ä»•äº‹ã‚’å¥ªã‚ã‚Œã‚‹ã¨ã„ã†ä¸å®‰ã‚‚åºƒãŒã£ã¦ãŠã‚Šã€ãƒªã‚¹ã‚­ãƒªãƒ³ã‚°ã®å¿…è¦æ€§ãŒé«˜ã¾ã£ã¦ã„ã‚‹ã€‚",
  url: "https://example.com/ai-workplace-revolution-2025"
}

// ãƒ†ã‚¹ãƒˆç”¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
const session = {
  platform: 'Twitter',
  style: 'æ´å¯Ÿçš„'
}

async function testConceptGeneration() {
  const prompt = `ã‚ãªãŸã¯ã€æ–°ãŸãªãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç‰¹å®šã—ã€æµè¡Œã®æ³¢ãŒãƒ”ãƒ¼ã‚¯ã«é”ã™ã‚‹å‰ã«ãã®æ³¢ã«ä¹—ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ä½œæˆã™ã‚‹ãƒã‚ºã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æˆ¦ç•¥å®¶ã§ã™ã€‚

ä»¥ä¸‹ã®ãƒˆãƒ”ãƒƒã‚¯ã«ã¤ã„ã¦ã€ã€${session.platform}ã€‘ã§ã€${session.style}ã€‘ã‚¹ã‚¿ã‚¤ãƒ«ã§ãƒã‚ºã‚‹æŠ•ç¨¿ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’3ã¤ä½œæˆã—ã¦ãã ã•ã„ã€‚

ãƒˆãƒ”ãƒƒã‚¯: ${mockTopic.TOPIC}
åˆ†æ: ${mockTopic.perplexityAnalysis}
URL: ${mockTopic.url}

ã€ãƒ•ãƒƒã‚¯ã€‘
ä¸‹è¨˜ã®5ç¨®é¡ã®ã„ãšã‚Œã‹ã€ã‚ã‚‹ã„ã¯è¤‡æ•°ã‚’ç”¨ã„ã¦3ã¤ãƒ•ãƒƒã‚¯ã‚’è€ƒãˆã¦ãã ã•ã„
1. æ„å¤–æ€§ï¼ˆSurpriseï¼‰
2. ç·Šæ€¥æ€§ï¼ˆUrgencyï¼‰
3. è‡ªå·±æŠ•å½±ï¼ˆIdentityï¼‰
4. æ•°å­—ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆClarityï¼‰
5. å•ã„ãƒ»æœªå®Œæ€§ï¼ˆTensionï¼‰

ã€è§’åº¦ã€‘
ãƒ•ãƒƒã‚¯ã‚’ã‚‚ã¨ã«ã€ä»¥ä¸‹ã‚’å‚è€ƒã«ç‹¬è‡ªè§’åº¦ã‚’3ã¤è€ƒãˆã¦ãã ã•ã„
- åå¯¾æ´¾ã¯ä¸–è«–ã«ç•°è­°ã‚’å”±ãˆã‚‹
- å°‚é–€å®¶ã«ã‚ˆã‚‹å†…éƒ¨è¦–ç‚¹ã®åˆ†æ
- å€‹äººçš„ãªã¤ãªãŒã‚Šã®ç‰©èª
- æ•™è‚²ã®å†…è¨³
- æ¬¡ã«ä½•ãŒèµ·ã“ã‚‹ã‹ã‚’äºˆæ¸¬ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
- èˆå°è£ã®æ´å¯Ÿ
- éå»ã®ã‚¤ãƒ™ãƒ³ãƒˆã¨ã®æ¯”è¼ƒå†…å®¹

ã€æŠ•ç¨¿æ§‹é€ ã€‘
ä¸‹è¨˜ã®æ§‹é€ ã§ã€æŠ•ç¨¿æ§‹é€ ã‚’ä½œæˆã—ã¦ãã ã•ã„
1.ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ãƒ•ãƒƒã‚¯
ã€€ğŸ‘‰ èˆˆå‘³ã‚’å¼•ã1è¡Œï¼ˆå•ã„ãƒ»é©šããƒ»çµè«–ã®é€†æç¤ºï¼‰
2.èƒŒæ™¯ï¼å•é¡Œæèµ·ï¼ˆWhyï¼‰
ã€€ğŸ‘‰ ãªãœãã‚ŒãŒé‡è¦ãªã®ã‹ï¼ä½•ãŒå•é¡Œãªã®ã‹
3.å…·ä½“çš„ãªä¸­èº«ï¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆWhat/Howï¼‰
ã€€ğŸ‘‰ ãƒã‚¦ãƒã‚¦ãƒ»ä½“é¨“è«‡ãƒ»ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ»ç®‡æ¡æ›¸ãã§ã‚‚OK
4.å†…çœãƒ»å…±æ„Ÿãƒ»ã¾ã¨ã‚ï¼ˆSo Whatï¼‰
ã€€ğŸ‘‰ èª­è€…ã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ã„ã€æ„å‘³ã¥ã‘ï¼ä¾¡å€¤åŒ–ã™ã‚‹
5.CTAï¼ˆCall to Actionï¼‰
ã€€ğŸ‘‰ ãƒªãƒ—ãƒ»RTãƒ»ä¿å­˜ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª˜å°ãªã©

ã€ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ¡ˆã€‘
ä¸Šè¨˜ã«ãµã•ã‚ã—ã„ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ¡ˆã‚’æç¤ºã—ã¦ãã ã•ã„

ã€æŠ•ç¨¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‘
ä¸Šè¨˜ã«ãµã•ã‚ã—ã„æŠ•ç¨¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æç¤ºã—ã¦ãã ã•ã„

ã€ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°æ¡ˆã€‘
ä¸Šè¨˜ã«ãµã•ã‚ã—ã„ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’3ã¤æç¤ºã—ã¦ãã ã•ã„

å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§3ã¤ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
[
  {
    "conceptId": "topic1_concept1",
    "format": "single",
    "hookType": "ä½¿ç”¨ã—ãŸãƒ•ãƒƒã‚¯ã®ç¨®é¡ï¼ˆä¾‹ï¼šæ„å¤–æ€§ã€ç·Šæ€¥æ€§ãªã©ï¼‰",
    "angle": "é¸æŠã—ãŸè§’åº¦ï¼ˆä¾‹ï¼šå€‹äººçš„ãªã¤ãªãŒã‚Šã®ç‰©èªï¼‰",
    "structure": {
      "openingHook": "èˆˆå‘³ã‚’å¼•ã1è¡Œ",
      "background": "ãªãœãã‚ŒãŒé‡è¦ãªã®ã‹ï¼ä½•ãŒå•é¡Œãªã®ã‹",
      "mainContent": "å…·ä½“çš„ãªä¸­èº«ï¼ã‚¹ãƒˆãƒ¼ãƒªãƒ¼",
      "reflection": "èª­è€…ã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ã„ã€æ„å‘³ã¥ã‘ï¼ä¾¡å€¤åŒ–",
      "cta": "ãƒªãƒ—ãƒ»RTãƒ»ä¿å­˜ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª˜å°ãªã©"
    },
    "visual": "ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ¡ˆã®èª¬æ˜",
    "timing": "æŠ•ç¨¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ææ¡ˆ",
    "hashtags": ["ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°1", "ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°2", "ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°3"]
  },
  {
    "conceptId": "topic1_concept2",
    "format": "thread",
    "hookType": "ä½¿ç”¨ã—ãŸãƒ•ãƒƒã‚¯ã®ç¨®é¡",
    "angle": "é¸æŠã—ãŸè§’åº¦",
    "structure": {
      "openingHook": "èˆˆå‘³ã‚’å¼•ã1è¡Œ",
      "background": "èƒŒæ™¯ï¼å•é¡Œæèµ·",
      "mainContent": "å…·ä½“çš„ãªä¸­èº«ï¼ˆthreadå½¢å¼ã®å ´åˆã¯å„ãƒ„ã‚¤ãƒ¼ãƒˆã®æ¦‚è¦ï¼‰",
      "reflection": "å†…çœãƒ»å…±æ„Ÿãƒ»ã¾ã¨ã‚",
      "cta": "CTA"
    },
    "visual": "ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ¡ˆ",
    "timing": "æŠ•ç¨¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°",
    "hashtags": ["ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°1", "ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°2", "ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°3"]
  },
  {
    "conceptId": "topic1_concept3",
    "format": "carousel",
    "hookType": "ä½¿ç”¨ã—ãŸãƒ•ãƒƒã‚¯ã®ç¨®é¡",
    "angle": "é¸æŠã—ãŸè§’åº¦",
    "structure": {
      "openingHook": "èˆˆå‘³ã‚’å¼•ã1è¡Œ",
      "background": "èƒŒæ™¯ï¼å•é¡Œæèµ·",
      "mainContent": "å…·ä½“çš„ãªä¸­èº«ï¼ˆcarouselå½¢å¼ã®å ´åˆã¯å„ã‚¹ãƒ©ã‚¤ãƒ‰ã®æ¦‚è¦ï¼‰",
      "reflection": "å†…çœãƒ»å…±æ„Ÿãƒ»ã¾ã¨ã‚",
      "cta": "CTA"
    },
    "visual": "ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ¡ˆ",
    "timing": "æŠ•ç¨¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°",
    "hashtags": ["ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°1", "ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°2", "ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°3"]
  }
]`

  try {
    console.log('ğŸš€ æ–°ã—ã„ã‚³ãƒ³ã‚»ãƒ—ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ãƒ†ã‚¹ãƒˆé–‹å§‹\n')
    console.log('ğŸ“Š å…¥åŠ›ãƒˆãƒ”ãƒƒã‚¯:')
    console.log(`- ã‚¿ã‚¤ãƒˆãƒ«: ${mockTopic.TOPIC}`)
    console.log(`- åˆ†æ: ${mockTopic.perplexityAnalysis}`)
    console.log(`- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : ${session.platform}`)
    console.log(`- ã‚¹ã‚¿ã‚¤ãƒ«: ${session.style}`)
    console.log('\nâ³ GPT-4oã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...\n')

    const response = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        {
          role: 'system',
          content: 'ã‚ãªãŸã¯ã€æ–°ãŸãªãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç‰¹å®šã—ã€æµè¡Œã®æ³¢ãŒãƒ”ãƒ¼ã‚¯ã«é”ã™ã‚‹å‰ã«ãã®æ³¢ã«ä¹—ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ä½œæˆã™ã‚‹ãƒã‚ºã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æˆ¦ç•¥å®¶ã§ã™ã€‚JSONå½¢å¼ã§æ­£ç¢ºã«å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚'
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      temperature: 0.8,
      max_tokens: 3000
    })

    const content = response.choices[0].message.content || '[]'
    console.log('ğŸ“ GPTã‹ã‚‰ã®ç”Ÿã®å¿œç­”:')
    console.log(content)
    console.log('\n---\n')

    // JSONã‚’ãƒ‘ãƒ¼ã‚¹
    let concepts = []
    try {
      concepts = JSON.parse(content)
    } catch (e) {
      console.error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã€‚ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¢ã—ã¾ã™...')
      const jsonMatch = content.match(/\[[\s\S]*\]/)
      if (jsonMatch) {
        concepts = JSON.parse(jsonMatch[0])
      }
    }

    console.log('âœ… ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚³ãƒ³ã‚»ãƒ—ãƒˆæ•°:', concepts.length)
    console.log('\nğŸ“‹ ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ã‚»ãƒ—ãƒˆè©³ç´°:\n')

    // å„ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’è©³ç´°è¡¨ç¤º
    concepts.forEach((concept, index) => {
      console.log(`\n========== ã‚³ãƒ³ã‚»ãƒ—ãƒˆ ${index + 1} ==========`)
      console.log(`ID: ${concept.conceptId}`)
      console.log(`å½¢å¼: ${concept.format}`)
      console.log(`ãƒ•ãƒƒã‚¯ã‚¿ã‚¤ãƒ—: ${concept.hookType}`)
      console.log(`è§’åº¦: ${concept.angle}`)
      console.log('\nã€æŠ•ç¨¿æ§‹é€ ã€‘')
      console.log(`1. ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ãƒ•ãƒƒã‚¯:\n   ${concept.structure.openingHook}`)
      console.log(`2. èƒŒæ™¯ï¼å•é¡Œæèµ·:\n   ${concept.structure.background}`)
      console.log(`3. å…·ä½“çš„ãªä¸­èº«:\n   ${concept.structure.mainContent}`)
      console.log(`4. å†…çœãƒ»å…±æ„Ÿãƒ»ã¾ã¨ã‚:\n   ${concept.structure.reflection}`)
      console.log(`5. CTA:\n   ${concept.structure.cta}`)
      console.log(`\nãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ¡ˆ: ${concept.visual}`)
      console.log(`æŠ•ç¨¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°: ${concept.timing}`)
      console.log(`ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°: ${concept.hashtags.join(', ')}`)
    })

    console.log('\n\nâœ… ãƒ†ã‚¹ãƒˆå®Œäº†ï¼')
    console.log('\nğŸ’¡ ä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°:', response.usage?.total_tokens || 'ä¸æ˜')

  } catch (error) {
    console.error('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error)
    if (error.response) {
      console.error('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', error.response.data)
    }
  }
}

// ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
testConceptGeneration()