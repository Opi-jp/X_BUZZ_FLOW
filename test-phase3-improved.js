require('dotenv').config();
const OpenAI = require('openai');

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

async function testPhase3WithImprovedConcept() {
  // æ”¹å–„ã•ã‚ŒãŸã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼ˆDè¦ç´ 5ã¤ï¼‰
  const improvedConcepts = [
    {
      A: "video",
      B: "ã€Œã‚ãªãŸã®ä»•äº‹ã€AIã«å–ã‚‰ã‚Œã¡ã‚ƒã†ã‹ã‚‚ï¼Ÿï¼ã€",
      C: "AIã«ã‚ˆã‚‹æ¥­å‹™è‡ªå‹•åŒ–ãŒæ–°å’ã®ã‚¹ã‚­ãƒ«ã‚·ãƒ•ãƒˆã‚’è¿«ã‚‹ç¾çŠ¶",
      D: [
        "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚„å¥‘ç´„æ›¸ãƒ¬ãƒ“ãƒ¥ãƒ¼ãªã©AIãŒæ—¢ã«ä»£æ›¿ã—ã¦ã„ã‚‹æ¥­å‹™ã®å…·ä½“ä¾‹ã‚’ç´¹ä»‹ã€‚",
        "AIã®é€²åŒ–ã§æ±‚ã‚ã‚‰ã‚Œã‚‹æ–°ã—ã„ã‚¹ã‚­ãƒ«ã‚»ãƒƒãƒˆã‚’æç¤ºã€‚",
        "ã€Œã‚ãªãŸã®ã‚¹ã‚­ãƒ«ã¯å¤§ä¸ˆå¤«ï¼Ÿä»Šã™ãã‚¹ã‚­ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ã€ã¨è¦–è´è€…ã«å•ã„ã‹ã‘ã‚‹ã€‚",
        "ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«: å„æ¥­å‹™ã®AIå°å…¥å‰å¾Œã®æ¯”è¼ƒæ˜ åƒã€‚",
        "ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°: #AIé©å‘½ #ã‚¹ã‚­ãƒ«ã‚·ãƒ•ãƒˆ #æœªæ¥ã®åƒãæ–¹"
      ],
      title: "AIãŒæ–°å’æ¥­å‹™ã‚’ã©ã†å¤‰ãˆã¦ã„ã‚‹ã‹ï¼Ÿ",
      newsSource: "Tech Insider",
      sourceUrl: "https://www.techinsider.com/ai-impact-on-entry-level-jobs"
    }
  ];

  const context = {
    platform: 'Twitter',
    concepts: improvedConcepts
  };

  // Phase 3ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆorchestrated-cot-strategy.tsã‹ã‚‰ï¼‰
  const phase3IntegratePrompt = `
# å‰ãƒ•ã‚§ãƒ¼ã‚ºã§ä½œæˆã•ã‚ŒãŸ3ã¤ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

ã€ã‚³ãƒ³ã‚»ãƒ—ãƒˆã€‘
{concepts}

# ã‚¿ã‚¹ã‚¯
ä¸Šè¨˜ã®3ã¤ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆå…¨ã¦ã«åŸºã¥ã„ã¦ã€{platform}ã«ã™ãã«ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆå¯èƒ½ãªå®Œå…¨ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
å„ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®Aã€Bã€Cã€Dã‚’åŠ¹æœçš„ã«ä½¿ã£ã¦ã€é­…åŠ›çš„ãªæŠ•ç¨¿ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## å„ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®è¦ç´ ï¼ˆAã€Bã€Cã€Dï¼‰ã‚’åŠ¹æœçš„ã«ä½¿ã†æ–¹æ³•
- **Aï¼ˆå½¢å¼ï¼‰**: æŒ‡å®šã•ã‚ŒãŸå½¢å¼ï¼ˆthread/video/carouselï¼‰ã«é©ã—ãŸæ§‹æˆã«ã™ã‚‹
- **Bï¼ˆãƒ•ãƒƒã‚¯ï¼‰**: ã“ã‚Œã‚’å†’é ­ã«ä½¿ç”¨ã—ã¦æ³¨ç›®ã‚’é›†ã‚ã‚‹ï¼ˆå¤šå°‘ã‚¢ãƒ¬ãƒ³ã‚¸ã—ã¦ã‚‚è‰¯ã„ãŒã€æœ¬è³ªã¯ç¶­æŒï¼‰
- **Cï¼ˆè§’åº¦/ç‹¬è‡ªã®è¦–ç‚¹ï¼‰**: ã“ã®è¦–ç‚¹ã‚’æ˜ç¢ºã«æœ¬æ–‡å…¨ä½“ã«åæ˜ ã•ã›ã€ãã®è§’åº¦ã‹ã‚‰ä¸€è²«ã—ã¦èªã‚‹
- **Dï¼ˆã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰**: 5ã¤å…¨ã¦ã®ãƒã‚¤ãƒ³ãƒˆã‚’åŠ¹æœçš„ã«æ´»ç”¨ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å±•é–‹ã™ã‚‹ï¼š
  - å…·ä½“ä¾‹ã‚„æ´å¯Ÿã¯è©³ã—ãèª¬æ˜
  - CTAã¯å¿…ãšå«ã‚ã‚‹
  - ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«èª¬æ˜ã‚’è¦–è¦šçš„èª¬æ˜ã¨ã—ã¦å«ã‚ã‚‹
  - ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’æŠ•ç¨¿ã«å«ã‚ã‚‹
- **newsSource**ã¨**sourceUrl**: ä¿¡é ¼æ€§ã®ã‚ã‚‹æƒ…å ±æºã¨ã—ã¦å¿…ãšå«ã‚ã‚‹

## é‡è¦ãªè¦ä»¶
- **å¿…ãšAã€Bã€Cã€Dã®å…¨è¦ç´ ã‚’åŠ¹æœçš„ã«ä½¿ç”¨ã™ã‚‹ã“ã¨**
- Cï¼ˆç‹¬è‡ªã®è¦–ç‚¹ï¼‰ã¯å˜ã«è¨€åŠã™ã‚‹ã®ã§ã¯ãªãã€ãã®è¦–ç‚¹ã‹ã‚‰èªã‚‹ã‚¹ã‚¿ãƒ³ã‚¹ã§å…¨ä½“ã‚’æ§‹æˆã™ã‚‹ã“ã¨
- Dï¼ˆã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰ã®5ã¤ã®è¦ç´ ã¯å…¨ã¦ä½•ã‚‰ã‹ã®å½¢ã§æŠ•ç¨¿ã«åæ˜ ã•ã›ã‚‹ã“ã¨
- ã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆã€æ›¸å¼ã€æ”¹è¡Œã€çµµæ–‡å­—ã€ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’å«ã‚ã‚‹
- å®Œæˆã•ã›ã¦ã™ãã«æŠ•ç¨¿ã§ãã‚‹ã‚ˆã†ã«æº–å‚™ã™ã‚‹
- äººé–“ã«ã‚ˆã‚‹æ–‡ä½“ãƒ»ãƒˆãƒ¼ãƒ³ã®å¾®èª¿æ•´ã¯å‰æã¨ã™ã‚‹

# JSONå‡ºåŠ›å½¢å¼
å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
{
  "contents": [
    {
      "conceptNumber": 1,
      "title": "ã‚³ãƒ³ã‚»ãƒ—ãƒˆ1ã®ã‚¿ã‚¤ãƒˆãƒ«",
      "mainPost": "å®Œå…¨ãªæŠ•ç¨¿æ–‡ï¼ˆæ”¹è¡Œã€çµµæ–‡å­—ã€ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°å«ã‚€ï¼‰",
      "hashtags": ["ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°1", "ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°2"],
      "visualDescription": "å¿…è¦ãªç”»åƒ/å‹•ç”»ã®è©³ç´°ãªèª¬æ˜",
      "postingNotes": "å…·ä½“çš„ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨æœ€é©åŒ–ã®ãƒ’ãƒ³ãƒˆ",
      "newsSource": "ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚½ãƒ¼ã‚¹å",
      "sourceUrl": "ã‚½ãƒ¼ã‚¹URL"
    }
  ]
}`;

  // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è£œé–“
  const prompt = phase3IntegratePrompt.replace(/{(\w+)}/g, (match, key) => {
    const value = context[key];
    if (value && typeof value === 'object') {
      return JSON.stringify(value, null, 2);
    }
    return value || match;
  });

  console.log('=== Phase 3 æ”¹å–„ãƒ†ã‚¹ãƒˆ ===\n');
  console.log('ğŸ“‹ å…¥åŠ›ã‚³ãƒ³ã‚»ãƒ—ãƒˆ:');
  console.log(`Dè¦ç´ æ•°: ${improvedConcepts[0].D.length}`);
  console.log('\nğŸ¤– GPTã«é€ä¿¡ä¸­...\n');

  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        { 
          role: 'system', 
          content: 'ã‚ãªãŸã¯ã€æ–°ãŸãªãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ç‰¹å®šã—ã€æµè¡Œã®æ³¢ãŒãƒ”ãƒ¼ã‚¯ã«é”ã™ã‚‹å‰ã«ãã®æ³¢ã«ä¹—ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ä½œæˆã™ã‚‹ãƒã‚ºã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æˆ¦ç•¥å®¶ã§ã™ã€‚' 
        },
        { role: 'user', content: prompt }
      ],
      temperature: 0.8,
      max_tokens: 4000,
      response_format: { type: 'json_object' }
    });

    const result = JSON.parse(completion.choices[0].message.content || '{}');
    
    if (result.contents && result.contents[0]) {
      const content = result.contents[0];
      console.log('âœ… ç”ŸæˆæˆåŠŸï¼\n');
      console.log('ğŸ“ ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„:');
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log(content.mainPost);
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
      console.log('\nğŸ” è¦ç´ ã®åæ˜ ãƒã‚§ãƒƒã‚¯:');
      console.log(`Bï¼ˆãƒ•ãƒƒã‚¯ï¼‰åæ˜ : ${content.mainPost.includes('AIã«å–ã‚‰ã‚Œ') ? 'âœ…' : 'âŒ'}`);
      console.log(`Cï¼ˆã‚¹ã‚­ãƒ«ã‚·ãƒ•ãƒˆè¦–ç‚¹ï¼‰åæ˜ : ${content.mainPost.includes('ã‚¹ã‚­ãƒ«') ? 'âœ…' : 'âŒ'}`);
      console.log(`D-3ï¼ˆCTAï¼‰åæ˜ : ${content.mainPost.includes('ã‚¹ã‚­ãƒ«ãƒã‚§ãƒƒã‚¯') ? 'âœ…' : 'âŒ'}`);
      console.log(`D-5ï¼ˆãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼‰åæ˜ : ${content.mainPost.includes('#AIé©å‘½') ? 'âœ…' : 'âŒ'}`);
    }
    
  } catch (error) {
    console.error('ã‚¨ãƒ©ãƒ¼:', error);
  }
}

testPhase3WithImprovedConcept();