# X_BUZZ_FLOW 作業記録

## プロジェクトオーナーの目標とビジョン

### 背景
- LLMの進展により、従来までの「会社で働く」「受託で仕事を受ける」などの働き方に大きな変革が訪れると予想
- 50歳を超えてセカンドキャリアを考える必要がある
- 自由な時間は確保したいので、TwitterやSNSを駆使して、ベーシックインカムと影響力を確保する必要がある

### キャリア
- 25歳のときに友人とNAKEDという映像制作会社を設立
- 以来、23年にわたりクリエイティブディレクター／プロデューサーとして活動
- 2012年よりプロジェクションマッピングなどで有名になる
- 映像／デザイン／WEB／マーケティングの分野で活動実績あり
- 大屋友紀雄で検索すればそれなりに実績の結果がでる

### 発信軸
- **メインテーマ**: クリエイティブの発想を使ってLLMをどう活用しながら、新しい時代を生き抜くか
  - LLMをクリエイティブの現場にどう活かすか、ということではない
  - 23年のクリエイティブ経験を活かした独自の視点
- **サブテーマ**: 
  - AI関連の紹介（フォロワーを集めるため）
  - 働き方などの未来予測

### 短期KPI（3ヶ月）
- **フォロワー**: 青バッジフォロワー2,000人達成
- **インプレッション**: 500万インプレッション達成
- **収益化**: Xサブスクライブ機能での収入確立

## システム概要（2025年6月時点）

### 技術スタック
- **Frontend**: Next.js 15.3 (App Router) + TypeScript + Tailwind CSS
- **Backend**: Next.js API Routes
- **Database**: PostgreSQL (Supabase)
- **AI**: GPT-4o (OpenAI) + Claude 3 Opus (Anthropic)
- **ORM**: Prisma

### 重要な実装詳細

#### Chain of Thought (CoT) 実装
- **5段階プロンプト構造**を採用（ChatGPTプロンプトに基づく）
- 各ステップの結果をDBに保存し、次ステップで参照
- プロンプトの品質が全体の精度に大きく影響するため、簡略化は避ける

#### Step 1の2段階実装（JSON切れ対策）
```
Phase 1-A: Responses API + Web検索で記事URL収集
Phase 1-B: Chat Completions APIで詳細分析（max_tokens: 4000）
```

### データ収集の制限事項（2025年6月現在）
- **Twitter API**: Metrics系APIが使用不可（2025年より制限）
- **代替手段**: Kaito API (Apify) を使用してバズ投稿とメトリクスを収集
  - エンゲージメント数、インプレッション数を取得可能
  - kaitoeasyapi.comのエンドポイントを使用
- RSS収集を中心とした情報収集システム

## Vercelデプロイ時の注意事項

### 環境差異によるエラー防止策

1. **Node.jsバージョンの指定**
   - package.jsonに`"engines": { "node": "18.x" }`を明記

2. **TypeScript設定**
   - config構造の違いに注意：
   ```typescript
   // 安全なアクセス方法
   config.config?.expertise || config.expertise || 'デフォルト値'
   ```

3. **データベース接続**
   - Pooler URL（アプリケーション用）: Vercel環境で使用
   - Direct URL（マイグレーション用）: ローカル開発で使用

4. **ファイル名の大文字小文字**
   - Macは区別しないが、Vercel（Linux）は区別する
   - import文とファイル名を厳密に一致させる

### Vercelとローカル環境の同期

1. **環境変数の同期**
   ```bash
   # Vercel CLIで環境変数をプル
   vercel env pull .env.local
   ```
   - Vercelダッシュボードで設定した環境変数をローカルに反映
   - 新しい環境変数追加時は必ず両環境で設定

2. **ビルドテスト**
   ```bash
   # ローカルで本番ビルドを実行
   npm run build
   # 成功後にデプロイ
   git push origin main
   ```

3. **データベーススキーマの同期**
   - Prismaマイグレーションは必ずローカルで実行・テスト
   - 本番DBへの適用は慎重に（データ損失に注意）

4. **依存関係の管理**
   - package-lock.jsonを必ずコミット
   - 新しいパッケージ追加後は必ずビルドテスト

## GPTバイラルシステム完成版（2025年6月13日）

### 5段階Chain of Thought実装完了

**System Status: ✅ FULLY OPERATIONAL**

#### 完全動作確認済み（2025/06/13）
- **Step 1**: Web検索+詳細分析（46秒、9記事収集）
- **Step 2**: トレンド評価（10秒、機会スコアリング）
- **Step 3**: コンセプト生成（29秒、3つのコンセプト）
- **Step 4**: 完全コンテンツ生成（27秒、投稿準備完了）
- **Step 5**: 実行戦略策定（29秒、KPI・戦略設定）

**総実行時間**: 141秒（約2分20秒）
**生成コンテンツ例**: 「🌟AIが未来の働き方を革命！AIエージェントがどのように私たちの仕事を変えるか、知っていますか？ #AI #働き方革命」

### 投稿支援機能実装（2025/06/13）

#### Phase 1 完成機能
1. **下書き管理システム**
   - 編集API: `/api/viral/drafts/[id]`
   - 編集UI: `/app/viral/drafts/[id]/page.tsx`
   - 文字数カウント、ハッシュタグ管理

2. **即座投稿機能**
   - API: `/api/viral/post-draft`
   - Twitter OAuth認証連携
   - 下書き一覧から「今すぐ投稿」ボタン

3. **パフォーマンス追跡**
   - API: `/api/viral/performance/[id]`
   - 30分、1時間、24時間後の自動メトリクス取得
   - エンゲージメント率計算

#### 技術的解決事項
- Vercel PROプラン対応（maxDuration: 300秒）
- 動的パラメータ名統一（[draftId]→[id]）
- TypeScriptスコープエラー修正
- Step 1のタイムアウト対策（記事数削減、トークン数最適化）

### 技術実装詳細

#### 使用AI API
1. **OpenAI GPT-4o**（メイン）
   - Chain of Thought全5ステップ
   - コンテンツ生成・分析
   - モデル切替可能（GPT-4-turbo-preview）

2. **Perplexity AI**
   - モデル: llama-3.1-sonar-large-128k-online
   - リアルタイム情報収集
   - 最新トレンド分析

3. **Anthropic Claude**
   - モデル: claude-3-haiku-20240307
   - 現状: テスト段階（本番未使用）

#### データベーステーブル構造
- **GptAnalysis**: 分析結果保存
- **ContentDraft**: 下書き管理
- **ViralOpportunity**: トレンド機会
- **ViralPost**: 投稿管理
- **ViralPostPerformance**: パフォーマンス追跡

### アクセスURL
- **メイン**: `/viral/gpt` - GPTバイラルシステム
- **下書き管理**: `/viral/drafts` - 下書き一覧・編集
- **ニュース管理**: `/news` - ニュース収集・分析
- **統合分析**: `/integrated-analysis` - 分析ダッシュボード

### 動作モード
- **通常モード**: 5段階Chain of Thought（約2分20秒）
- **高速モード**: chain-fast - 単発投稿生成（5秒以内）
- **ハイブリッドモード**: chain-hybrid - バランス型

## 仕様書レビュー結果（2025/06/13）

### 実装済み機能（90%完成）
- ✅ **フェーズ0-4の完全実装**
  - バズるコンテンツ戦略家としての人格設定
  - 5段階のChain of Thought実装
  - 各フェーズでのDB保存

- ✅ **技術的要件の達成**
  - Response API + GPT-4oでWeb検索実装
  - Function Callingを全ステップで活用
  - 2段階アプローチでタイムアウト対策

- ✅ **コンテンツ管理機能**
  - 編集画面（文字数カウント、ハッシュタグ管理）
  - 即座投稿機能
  - パフォーマンストラッキング

### 未実装・改善が必要な点
1. **検索カテゴリのハードコード問題**
   - 8カテゴリが固定されている
   - expertiseに基づく動的生成が必要

2. **スケジュール投稿機能**
   - DBにscheduledAtは保存されるが自動投稿なし
   - Vercel Cronまたは外部サービス実装が必要

3. **ABテスト機能**
   - オープニングフックのバリエーション生成
   - 結果分析機能

## 今後の作業

### Phase 2計画（優先度順）
1. **検索カテゴリの動的生成**
   - expertiseに基づくカテゴリ生成ロジック
   - 関連キーワードの動的抽出

2. **スケジュール投稿の完全実装**
   - Vercel Cronでの定期実行
   - 予約投稿の自動実行機能
   - 投稿結果の通知機能

3. **ABテスト機能**
   - オープニングフックのバリエーション生成
   - パフォーマンス比較分析
   - 勝ちパターンの自動学習

4. **分析機能の拡充**
   - 傾向分析ダッシュボード
   - 競合分析機能
   - ROI計算・最適化

5. **学習システム**
   - 過去の高パフォーマンス投稿分析
   - コンテンツパターンの自動学習
   - 個人化されたコンテンツ生成

## 重要な設計思想（Chain of Thought）

### バズるコンテンツ戦略家システム
このシステムは、ChatGPTで実績のある「バズるコンテンツ戦略家」プロンプトをAPI実装したものです。

#### 設計原則
1. **汎用性**: 特定分野（AI等）にハードコードしない
2. **ユーザー設定の3要素**:
   - 発信したい分野（自由入力）
   - プラットフォーム（Twitter/TikTok/Instagram/LinkedIn/YouTube）
   - コンテンツスタイル（教育/エンターテイメント/解説/個人的な話）
3. **視点の動的選択**: 固定視点は設けず、トレンドに最適な視点を都度選択
4. **Chain of Thought**: 各フェーズは前のフェーズの結果を引き継ぐ

#### フェーズ構成
- **Phase 1**: トレンド収集（全分野を網羅的に調査）
- **Phase 2**: 機会評価（ユーザー分野に関連するものを抽出・評価）
- **Phase 3**: コンセプト生成（3つの異なるアプローチ）
- **Phase 3B**: 完全なコンテンツ生成
- **Phase 4**: 実行戦略

#### 重要な注意事項
- 各フェーズで条件をハードコードしない
- オリジナルプロンプトの構造を忠実に再現
- この設計思想はClaude Codeのセッションが切れても保持すること

## 連絡先・リポジトリ
- GitHub: https://github.com/Opi-jp/X_BUZZ_FLOW
- Vercel: https://x-buzz-flow.vercel.app

---
*最終更新: 2025/06/13*