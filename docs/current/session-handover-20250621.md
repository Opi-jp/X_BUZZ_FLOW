# セッション引き継ぎ文書（2025年6月21日）

## 🚨 次セッションへの重要な引き継ぎ

### 現在の状況

#### 作業内容
- **DB主導アーキテクチャへの移行作業**: フロントエンド主導からDB主導への転換を試みた
- **16ステップフロー実装**: `/app/create/flow/[id]/page.tsx`の改修中
- **ビルド状態**: 成功（エラーなし）

#### 直面した問題
1. **ツール爆発問題**
   - 30個以上の開発ツールが存在
   - セッション開始時に全ツールの起動指示が必要
   - 人間の記憶限界を超過

2. **テストスクリプト増殖問題**
   - 1日で50個のtest-*.jsファイルが生成
   - エラー回避のためのモックスクリプトが蓄積
   - 根本解決されずに技術的負債が増大

3. **開発ワークフローの破綻**
   - フロント修正 → バックエンドエラー → バックエンド修正 → フロントエラーの無限ループ
   - DB、Schema、Frontendの3層が同期していない
   - API contractsは作成したがアーカイブされ活用されていない

### 技術的な詳細

#### 作成したファイル
```
/lib/hooks/use-db-flow-session.ts              # DB主導セッション管理フック
/app/api/create/flow/[id]/update/route.ts      # セッション更新API（未完成）
/scripts/subtask-monitor.js                     # サブタスク監視ツール
/scripts/add-flow-fields.js                     # DBフィールド追加スクリプト（未使用）
/scripts/db-add-flow-fields.sql                 # SQL直書き（使用すべきでない）
```

#### 修正したファイル
```
/app/create/flow/[id]/page.tsx                  # DB主導への移行途中
複数のページファイル                              # useSearchParams() Suspense境界エラー修正
/lib/flow/types.ts                              # FlowStep型にautoExecute追加
/app/api/create/flow/start/route.ts             # Prismaエラー修正
```

#### 削除/アーカイブしたファイル
```
/app/generation/*                               # archive/old-page-structure-20250621/へ移動
/app/api/intelligence/*等                       # archive/old-api-structure-20250621/へ移動
```

### 根本的な問題と教訓

#### 問題の本質
1. **「作る」ことへの偏重**: エラーが出るたびに新しいスクリプト/ツール/エンドポイントを作成
2. **既存資産の無視**: 動作しているAPIやツールがあるのに新規作成
3. **複雑性の増大**: 管理ツールを管理するツールが必要なほど複雑化

#### 得られた教訓
- **作らない勇気**: 新規作成より既存活用
- **削除の重要性**: 複雑性を減らすことが最優先
- **基本への回帰**: npm run build/dev/git statusで十分
- **DB主導の本質**: DBの設計を先に正しくし、フロントエンドを適応させる

### 次回の作業指針

#### やるべきこと
1. **テストスクリプトの全削除**
   ```bash
   find . -name "test-*-202506*.js" -delete
   ```

2. **既存APIの確認と活用**
   ```bash
   node scripts/dev-tools/api-dependency-scanner.js
   # 実際に使用中のAPIを確認し、それらを活用
   ```

3. **DB主導の正しい実装**
   - Prismaスキーマの確認
   - 必要最小限のフィールド追加（current_step, post_format）
   - フロントエンドを既存DBフィールドに適応

#### やってはいけないこと
- 新しいテストスクリプトの作成
- 新しいエンドポイントの作成
- エラー回避のためのモック作成
- SQL直書きでのDB変更

### 現在の作業状態

#### DB状態
- `viral_sessions`テーブル: 既存フィールドのみ（current_step等は未追加）
- `viral_drafts`テーブル: viral_drafts_v2からリネーム済み
- マイグレーション: 2つが「適用済み」としてマーク

#### フロントエンド状態
- `/app/create/flow/[id]/page.tsx`: DB主導フックを追加したが未完成
- 存在しないDBフィールドを参照してエラーになる可能性

#### 推奨される次のステップ
1. 現在のDBスキーマで動作するようフロントエンドを修正
2. 本当に必要なフィールドのみPrismaマイグレーションで追加
3. 統合テストで動作確認

### 補足情報

- **開発サーバー**: tmux (xbuzz)で起動中
- **ビルド状態**: 成功（警告1件：カスタムフォント）
- **バックエンドエラー**: invokeRenderエラーが継続（影響は限定的）

---

**作成日時**: 2025年6月22日 0:00
**作成者**: Claude
**目的**: 次セッションでの作業継続性確保